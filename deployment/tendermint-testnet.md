# Tendermint Test Network Deployment

This folder provides a supporting set of scripts to help in
demonstrating/experimenting with the load testing tool.

## Requirements

* [Tendermint source](https://github.com/tendermint/tendermint)
* Python 3.7+
* Ansible 2.7+
* A CLI tool to generate bcrypt hashes (e.g.
  [bcrypt-me](https://github.com/thanethomson/bcrypt-me)). This is used to
  generate a bcrypt hash of the password for accessing the outage simulator
  server on your local machine.
* A few VMs for the test network with the following requirements on each
  machine:
  * Must have Python preinstalled (for Ansible)
  * Must be running systemd as their init system

## Usage
Use the following steps to deploy a multi-node Tendermint network using the
version of Tendermint you have cloned on your local machine.

### Step 1: Set up your Tendermint network configuration
Each Tendermint node needs configuration. This set of scripts makes use of the
`tendermint testnet` command to generate configuration files for each node prior
to deploying those nodes.

Make sure you've got a template configuration file handy somewhere - it will be
used as the base configuration file for all of your Tendermint nodes.

### Step 2: Configure your hosts
Create yourself an [Ansible inventory
file](https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html)
to specify all of the Tendermint nodes to which you want to deploy the
Tendermint network. **Note**: it is important to name your nodes in the same way
as below, where the node name has a prefix of `node` and a suffix of its number.

```ini
[tendermint]
node0 ansible_ssh_host=tm0.yourdns.com
node1 ansible_ssh_host=tm1.yourdns.com
node2 ansible_ssh_host=tm2.yourdns.com
node3 ansible_ssh_host=tm3.yourdns.com
```

This assumes that you've configured your `known_hosts` file to be able to SSH
into all of the above hosts without the following message coming up:

```
The authenticity of host '111.222.333.444 (111.222.333.444)' can't be established.
RSA key fingerprint is f3:cf:58:ae:71:0b:c8:04:6f:34:a3:b2:e4:1e:0c:8b.
Are you sure you want to continue connecting (yes/no)?
```

### Step 3: Configure your local environment
If you have an existing common Python 3 virtual environment set up elsewhere,
you can skip this step - just activate it and ensure you've got Ansible
installed in that virtual environment.

```bash
cd /path/to/github.com/interchainio/tm-load-test/deployment

# First set up your Python 3 virtual environment
python3 -m venv venv

# Activate your virtual environment
source venv/bin/activate

# Install Ansible
pip install ansible

# Check Ansible version
ansible-playbook --version
```

### Step 4: Deploy the test network
After activating your virtual environment, execute the `test-network.sh` script:

```bash
cd /path/to/github.com/interchainio/tm-load-test/deployment
./testnet.sh
```

This script does a few things:
1. (Optionally) Installs Tendermint locally. By default this is disabled, and is
   only enabled if you set the environment variable `INSTALL_TENDERMINT=1`.
2. Builds `tm-outage-sim-server` for Linux. To skip this, set the environment
   variable `NOBUILD=1`.
3. Builds Tendermint for Linux. By default, it looks in
   `$GOPATH/src/github.com/tendermint/tendermint` for your Tendermint source. To
   override this, specify `TENDERMINT_SRC=/path/to/your/tendermint/src`. Setting
   the environment variable `NOBUILD=1` will also skip this build step.
4. Deploys the outage simulator to the Tendermint nodes, as specified in the
   `[tendermint]` section of your Ansible `hosts` file. To skip this step, set
   the environment variable `DEPLOY_OUTAGE_SIM=0`. If a password is generated by
   the script (the default behaviour), it will be written out at the end of the
   final output log of the script's execution.
5. Generates configuration for the intended Tendermint nodes using the
   `tendermint testnet` command.
6. Deploys your local Tendermint version to the Tendermint nodes, as specified
   in the `[tendermint]` section of your Ansible `hosts` file. To skip this
   step, set the environment variable `DEPLOY_TENDERMINT=0`.

For example, to install your Tendermint version locally, skip building both the
`tm-outage-sim-server` and `tendermint` binaries, and only deploy the Tendermint
network, one would:

```bash
INSTALL_TENDERMINT=1 \
    NOBUILD=1 \
    DEPLOY_OUTAGE_SIM=0 \
    ./testnet.sh
```

## `testnet.sh` Environment Variables
The following environment variables allow for modification of the behaviour of
the `testnet.sh` script:

* `ANSIBLE_USER` - The SSH user to use to connect to the target servers.
* `BCRYPT_APP` - Allows one to override the bcrypt CLI application used to
  generate a bcrypt hash of the outage simulator's password.
* `DEPLOY_OUTAGE_SIM` - Whether or not to deploy the outage simulator. Set to 1
  by default. Set to 0 to disable.
* `DEPLOY_TENDERMINT` - Whether or not to deploy Tendermint. Set to 1 by
  default. Set to 0 to disable.
* `GEN_TESTNET_CONFIG` - Whether or not to generate Tendermint testnet
  configuration. Set to 1 by default. Set to 0 to disable (if, e.g., you have
  your own set of configuration files you want to deploy).
* `INSTALL_TENDERMINT` - Whether or not to install your Tendermint version
  locally prior to executing the remainder of the script. Set to 0 by default.
  Set to 1 to enable.
* `INVENTORY` - The path to the Ansible inventory file. Defaults to a `hosts`
  file in this deployment directory.
* `LOADTEST_SRC` - The path to the `tm-load-test` repository source code.
* `NOBUILD` - Set to 1 if you want to skip building `tm-load-test` and
  `tendermint` binaries.
* `OUTAGE_SIM_USER` - The username for authenticating against the outage
  simulator. Defaults to `loadtest`.
* `OUTAGE_SIM_PASSWORD` - The password for authenticating against the outage
  simulator. Defaults to a random hexadecimal password obtained from data from
  `/dev/urandom`.
* `OUTAGE_SIM_PASSWORD_HASH` - If not set, this requires a valid `BCRYPT_APP`
  parameter so that we can generate a bcrypt hash of the outage simulator
  password as part of the outage simulator's configuration.
* `OUTAGE_SIM_PORT` - The port on the target machines to which to bind the
  outage simulator server. Default: 26680.
* `TENDERMINT_SRC` - The path to your Tendermint source code. Defaults to
  `${GOPATH}/src/github.com/tendermint/tendermint`.
* `TM_CONFIG_TEMPLATE` - The path to a Tendermint configuration file that will
  be used as a template for the `tendermint testnet` command. By default this
  uses the `default-tendermint-config.toml` file in this directory.
* `TM_COPY_CONFIG` - Whether or not to copy the configuration (generated by
  `tendermint testnet`) across to the target nodes. Set to 1 by default. Set to
  0 to disable. **NOTE: By default, this will overwrite any pre-existing data in
  your Tendermint nodes' folders.**
* `TM_GROUP` - The UNIX system group to which to assign the Tendermint user.
  Defaults to `tendermint`.
* `TM_HOSTNAME_PREFIX` - The hostname prefix to use when calling the 
  `tendermint testnet` command. Defaults to `node`.
* `TM_HOSTNAME_SUFFIX` - The hostname suffix to use when calling the
  `tendermint testnet` command. Defaults to an empty string (i.e. no suffix).
* `TM_NON_VALIDATORS` - The number of non-validators for the
  `tendermint testnet` command. Defaults to 0.
* `TM_USER` - The UNIX system user for the Tendermint process. Defaults to
  `tendermint`.
* `TM_VALIDATORS` - The number of validators for the
  `tendermint testnet` command. Defaults to 4.
